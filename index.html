<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const supabase = window.supabase.createClient(
      'https://zzigzylypifjokskehkn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6aWd6eWx5cGlmam9rc2tlaGtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTQ5Njg4NzcsImV4cCI6MjAwMDU0NDg3N30.1zZKXgZ4gkUuYQ7gqvZgkXz8aZJvZzZzZzZzZzZzZzZ'
    );

    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      document.getElementById('test-form').style.display = user ? 'block' : 'none';
      document.getElementById('logout-btn').style.display = user ? 'inline-block' : 'none';
      document.getElementById('login-form').style.display = user ? 'none' : 'block';
    }

    checkAuth();

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        alert('Login failed: ' + error.message);
      } else {
        alert('Signed in successfully');
        checkAuth();
      }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      checkAuth();
    });

    document.getElementById('test-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) {
        alert('You must be signed in to submit.');
        return;
      }

      const form = e.target;
      const { error } = await supabase
        .from('hydrostatic_tests')
        .insert([{
          user_id: user.id,
          customer_name: form.customerName.value,
          address: form.address.value,
          test_date: form.testDate.value,
          technician_name: form.technicianName.value,
          test_location: form.testLocation.value,
          duration_minutes: parseInt(form.duration.value),
          outcome: form.outcome.value,
          anomalies: form.anomalies.value,
          notes: form.notes.value
        }]);

      if (error) {
        alert('Submission failed: ' + error.message);
      } else {
        alert('Test report submitted successfully!');
        form.reset();
      }
    });
  });
</script>
